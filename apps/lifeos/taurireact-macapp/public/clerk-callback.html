<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Returning to LifeOS…</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background: #0b0b0c;
        color: #f5f5f5;
      }
      .wrap {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .card {
        max-width: 520px;
        width: 100%;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 18px 16px;
        line-height: 1.4;
      }
      .title {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 8px 0;
      }
      .muted {
        opacity: 0.85;
        margin: 0 0 14px 0;
        font-size: 13px;
      }
      a {
        color: #7aa2ff;
        word-break: break-all;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <p class="title">Returning to LifeOS…</p>
        <p id="status" class="muted">
          If nothing happens, tap the link below.
        </p>
        <a id="openLink" href="#">Open LifeOS</a>
      </div>
    </div>

    <script>
      (function () {
        const incoming = new URL(window.location.href);

        // Preserve Clerk parameters for the app to consume.
        // Clerk may send params in the query string or in the hash in a few formats:
        // - #__clerk_ticket=...
        // - #?__clerk_ticket=...
        // - #/?__clerk_ticket=...
        // - #/some/path?__clerk_ticket=...
        const params = new URLSearchParams(incoming.search);

        function mergeParams(paramString) {
          if (!paramString) return;
          try {
            const extra = new URLSearchParams(paramString);
            for (const [k, v] of extra.entries()) {
              if (!params.has(k)) params.set(k, v);
            }
          } catch {}
        }

        if (incoming.hash && incoming.hash.length > 1) {
          const raw = incoming.hash.slice(1); // remove leading '#'
          if (raw.startsWith("/")) {
            const q = raw.indexOf("?");
            if (q >= 0) mergeParams(raw.slice(q + 1));
          } else if (raw.startsWith("?")) {
            mergeParams(raw.slice(1));
          } else {
            mergeParams(raw);
          }
        }

        const deepLink =
          "lifeos://callback" + (params.toString() ? `?${params.toString()}` : "");

        const link = document.getElementById("openLink");
        if (link) link.href = deepLink;

        // Attempt automatic redirect back to the app.
        window.location.replace(deepLink);

        // Update message if the OS blocks automatic open.
        setTimeout(() => {
          const status = document.getElementById("status");
          if (status) {
            status.textContent = "Tap “Open LifeOS” to return to the app.";
          }
        }, 900);
      })();
    </script>
  </body>
</html>

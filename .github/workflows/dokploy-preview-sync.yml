name: Sync Dokploy Preview with Convex

# Triggers when a PR is opened/updated AND livekit-voice-agent code changes
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "packages/livekit-voice-agent/**"
      - ".github/workflows/dokploy-preview-sync.yml"

env:
  DOKPLOY_APP_ID: r92eMjky2Tf04b37F1cLg
  DOKPLOY_BASE_URL: https://app.dokploy.com

jobs:
  sync-preview:
    runs-on: ubuntu-latest
    # Only run on PRs, not on the default branch
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Vercel deployment
        id: wait-vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo "Waiting for Vercel deployment to complete..."

          # Wait up to 10 minutes for deployment
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            # Get the latest deployment for this branch
            DEPLOYMENTS=$(curl -s \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?teamId=$VERCEL_ORG_ID&limit=5&state=READY")

            # Check if any deployment matches our branch
            BRANCH_NAME="${{ github.head_ref }}"
            DEPLOYMENT_URL=$(echo "$DEPLOYMENTS" | jq -r ".deployments[] | select(.meta.githubCommitRef == \"$BRANCH_NAME\") | .url" | head -1)

            if [ -n "$DEPLOYMENT_URL" ] && [ "$DEPLOYMENT_URL" != "null" ]; then
              echo "Found Vercel deployment: $DEPLOYMENT_URL"
              echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
              break
            fi

            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Deployment not ready yet, waiting 10s..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Timeout waiting for Vercel deployment"
            echo "deployment_url=" >> $GITHUB_OUTPUT
          fi

      - name: Get Convex Preview URL
        id: get-convex-url
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          BRANCH_NAME="${{ github.head_ref }}"

          # Get deployment details to find CONVEX_URL
          # First, get the deployment ID
          DEPLOYMENTS=$(curl -s \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?teamId=$VERCEL_ORG_ID&limit=10")

          DEPLOYMENT_ID=$(echo "$DEPLOYMENTS" | jq -r ".deployments[] | select(.meta.githubCommitRef == \"$BRANCH_NAME\") | .uid" | head -1)

          if [ -n "$DEPLOYMENT_ID" ] && [ "$DEPLOYMENT_ID" != "null" ]; then
            echo "Found deployment ID: $DEPLOYMENT_ID"

            # Get deployment environment variables
            DEPLOYMENT_ENV=$(curl -s \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID?teamId=$VERCEL_ORG_ID")

            # Debug: show structure
            echo "Checking deployment env structure..."

            # Try to extract CONVEX_URL - handle both object and array formats
            # First try as object keys
            CONVEX_URL=$(echo "$DEPLOYMENT_ENV" | jq -r '
              .build.env // {} |
              if type == "array" then
                (.[] | select(.key == "CONVEX_URL" or .key == "VITE_CONVEX_URL") | .value) // empty
              else
                (.CONVEX_URL // .VITE_CONVEX_URL // empty)
              end
            ' 2>/dev/null || echo "")

            if [ -n "$CONVEX_URL" ] && [ "$CONVEX_URL" != "null" ]; then
              # Convert .convex.cloud to .convex.site for HTTP actions
              CONVEX_SITE_URL=$(echo "$CONVEX_URL" | sed 's/\.convex\.cloud/.convex.site/')
              echo "Found Convex URL: $CONVEX_SITE_URL"
              echo "convex_url=$CONVEX_SITE_URL" >> $GITHUB_OUTPUT
            else
              echo "Could not find CONVEX_URL in deployment, using default"
              echo "convex_url=https://beaming-giraffe-300.convex.site" >> $GITHUB_OUTPUT
            fi
          else
            echo "No deployment found for branch $BRANCH_NAME, using default Convex URL"
            echo "convex_url=https://beaming-giraffe-300.convex.site" >> $GITHUB_OUTPUT
          fi

      - name: Update Dokploy Preview Environment
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          CONVEX_URL: ${{ steps.get-convex-url.outputs.convex_url }}
        run: |
          echo "Updating Dokploy previewEnv with CONVEX_URL: $CONVEX_URL"

          # Build the preview environment variables
          PREVIEW_ENV="LIVEKIT_URL=wss://livekit-dev.rocketjump.tech
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CONVEX_URL=$CONVEX_URL"

          # Update Dokploy application previewEnv via API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_BASE_URL/api/trpc/application.update" \
            -H "x-api-key: $DOKPLOY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"json\": {
                \"applicationId\": \"$DOKPLOY_APP_ID\",
                \"previewEnv\": \"$(echo "$PREVIEW_ENV" | sed ':a;N;$!ba;s/\n/\\n/g')\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully updated Dokploy previewEnv"
          else
            echo "Failed to update Dokploy: HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const convexUrl = '${{ steps.get-convex-url.outputs.convex_url }}';
            const body = `## Dokploy Preview Sync

            LiveKit Voice Agent preview will use:
            - **Convex URL**: \`${convexUrl}\`

            The Dokploy preview deployment has been configured to use this Convex backend.

            > Note: Preview deployments are created automatically when Dokploy detects the PR.`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Dokploy Preview Sync')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

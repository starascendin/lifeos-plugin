name: Preview Deployments

# Unified preview deployment workflow for PRs
# Handles: Convex Preview, Vercel Preview, Dokploy Preview
#
# Dokploy Strategy: Use label filtering to break the race condition
# 1. This workflow runs first (Convex deploy, update Dokploy previewEnv)
# 2. After updating previewEnv, we add the "deploy-preview" label to the PR
# 3. Dokploy is configured to only create previews for PRs with this label
# 4. Dokploy sees the label and creates preview with CORRECT previewEnv
#
# IMPORTANT: Configure Dokploy to require "deploy-preview" label for preview deployments
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "packages/holaaiconvex/**"
      - "packages/livekit-voice-agent/**"
      - "apps/lifeos/taurireact-macapp/**"
      - ".github/workflows/preview-deploy.yml"

env:
  DOKPLOY_APP_ID: r92eMjky2Tf04b37F1cLg
  DOKPLOY_BASE_URL: https://app.dokploy.com
  DOKPLOY_PREVIEW_LABEL: deploy-preview

permissions:
  contents: read
  pull-requests: write

jobs:
  # Step 1: Deploy Convex Preview (all other services depend on this)
  convex-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      convex_url: ${{ steps.deploy.outputs.convex_url }}
      convex_site_url: ${{ steps.deploy.outputs.convex_site_url }}
      preview_name: ${{ steps.deploy.outputs.preview_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Convex CLI
        run: npm install -g convex

      - name: Install dependencies
        working-directory: packages/holaaiconvex
        run: npm install

      - name: Deploy Convex Preview
        id: deploy
        working-directory: packages/holaaiconvex
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_PREVIEW_DEPLOY_KEY }}
        run: |
          # Create a preview name from the branch (sanitize for Convex)
          BRANCH_NAME="${{ github.head_ref }}"
          # Replace non-alphanumeric chars with dashes, lowercase
          PREVIEW_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          # Truncate to 32 chars max
          PREVIEW_NAME="${PREVIEW_NAME:0:32}"

          echo "Deploying Convex preview: $PREVIEW_NAME"

          # Deploy to preview and capture output
          DEPLOY_OUTPUT=$(npx convex deploy --preview-create "$PREVIEW_NAME" 2>&1) || {
            echo "Deploy output: $DEPLOY_OUTPUT"
            exit 1
          }

          echo "Deploy output:"
          echo "$DEPLOY_OUTPUT"

          # Extract the preview URL from the output
          CONVEX_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[a-zA-Z0-9-]+\.convex\.cloud' | head -1)

          if [ -z "$CONVEX_URL" ]; then
            echo "Could not extract Convex URL from deploy output, constructing it"
            CONVEX_URL="https://${PREVIEW_NAME}.convex.cloud"
          fi

          # Convert .convex.cloud to .convex.site for HTTP actions
          CONVEX_SITE_URL=$(echo "$CONVEX_URL" | sed 's/\.convex\.cloud/.convex.site/')

          echo "Convex Preview URL: $CONVEX_URL"
          echo "Convex Site URL: $CONVEX_SITE_URL"

          echo "convex_url=$CONVEX_URL" >> $GITHUB_OUTPUT
          echo "convex_site_url=$CONVEX_SITE_URL" >> $GITHUB_OUTPUT
          echo "preview_name=$PREVIEW_NAME" >> $GITHUB_OUTPUT

  # Step 2: Deploy Vercel Preview with correct Convex URL
  vercel-preview:
    runs-on: ubuntu-latest
    needs: convex-preview
    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_TAURI_LIFEOSAPP_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project with Preview Convex URL
        env:
          SKIP_CONVEX_DEPLOY: "1"
          VITE_CONVEX_URL: ${{ needs.convex-preview.outputs.convex_url }}
        run: |
          echo "Building with SKIP_CONVEX_DEPLOY=$SKIP_CONVEX_DEPLOY"
          echo "Building with VITE_CONVEX_URL=$VITE_CONVEX_URL"
          # Export vars for the vercel build subprocess
          export SKIP_CONVEX_DEPLOY
          export VITE_CONVEX_URL
          vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          # Deploy and capture the preview URL
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          echo "$DEPLOY_OUTPUT"

          # Extract the preview URL from output
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[a-zA-Z0-9-]+\.vercel\.app' | head -1)

          if [ -z "$PREVIEW_URL" ]; then
            # Try alternative pattern
            PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | tail -1 | tr -d '[:space:]')
          fi

          echo "Vercel Preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

  # Step 3: Update Dokploy Preview Environment and trigger via label
  # Strategy: Update previewEnv first, then add label to trigger Dokploy preview creation
  dokploy-preview:
    runs-on: ubuntu-latest
    needs: convex-preview
    outputs:
      label_added: ${{ steps.add_label.outputs.label_added }}

    steps:
      - name: Update Dokploy Preview Environment
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          CONVEX_URL: ${{ needs.convex-preview.outputs.convex_site_url }}
        run: |
          echo "Updating Dokploy previewEnv with CONVEX_URL: $CONVEX_URL"

          # Build the preview environment variables
          PREVIEW_ENV="LIVEKIT_URL=wss://livekit-dev.rocketjump.tech
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CONVEX_URL=$CONVEX_URL"

          # Update Dokploy application previewEnv via API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_BASE_URL/api/trpc/application.update" \
            -H "x-api-key: $DOKPLOY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"json\": {
                \"applicationId\": \"$DOKPLOY_APP_ID\",
                \"previewEnv\": \"$(echo "$PREVIEW_ENV" | sed ':a;N;$!ba;s/\n/\\n/g')\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully updated Dokploy previewEnv"
          else
            echo "Failed to update Dokploy: HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Add deploy-preview label to trigger Dokploy
        id: add_label
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ env.DOKPLOY_PREVIEW_LABEL }}';
            const prNumber = context.issue.number;

            console.log(`Adding label "${label}" to PR #${prNumber} to trigger Dokploy preview`);

            try {
              // First, ensure the label exists in the repo
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label
                });
              } catch (e) {
                if (e.status === 404) {
                  console.log(`Label "${label}" doesn't exist, creating it...`);
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: '0E8A16',
                    description: 'Triggers Dokploy preview deployment'
                  });
                }
              }

              // Add the label to the PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [label]
              });

              console.log(`Successfully added label "${label}" to PR #${prNumber}`);
              core.setOutput('label_added', 'true');
            } catch (error) {
              console.error(`Failed to add label: ${error.message}`);
              core.setOutput('label_added', 'false');
              // Don't fail the job - Dokploy preview can still be manually triggered
            }

  # Step 4: Comment on PR with all preview URLs
  comment:
    runs-on: ubuntu-latest
    needs: [convex-preview, vercel-preview, dokploy-preview]
    if: always() && needs.convex-preview.result == 'success'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const convexUrl = '${{ needs.convex-preview.outputs.convex_url }}';
            const convexSiteUrl = '${{ needs.convex-preview.outputs.convex_site_url }}';
            const previewName = '${{ needs.convex-preview.outputs.preview_name }}';
            const vercelUrl = '${{ needs.vercel-preview.outputs.preview_url }}' || 'N/A';
            const dokployStatus = '${{ needs.dokploy-preview.result }}';
            const labelAdded = '${{ needs.dokploy-preview.outputs.label_added }}';

            let dokployStatusText = 'â­ï¸ Skipped/Failed';
            let dokployNote = '';

            if (dokployStatus === 'success') {
              if (labelAdded === 'true') {
                dokployStatusText = 'âœ… Label added, preview deploying';
                dokployNote = `
            > â„¹ï¸ The \`deploy-preview\` label was added. Dokploy will create/update the preview with the correct \`CONVEX_URL\`.`;
              } else {
                dokployStatusText = 'âš ï¸ Label not added';
                dokployNote = `
            > âš ï¸ **Note**: Could not add the deploy-preview label. You may need to manually add the label or redeploy in Dokploy.`;
              }
            }

            const body = `## ðŸš€ Preview Deployments

            | Service | URL | Status |
            |---------|-----|--------|
            | **Convex Preview** | \`${previewName}\` | âœ… Deployed |
            | **Convex Cloud** | ${convexUrl} | âœ… Ready |
            | **Convex Site** | ${convexSiteUrl} | âœ… Ready |
            | **Vercel Preview** | ${vercelUrl} | ${vercelUrl !== 'N/A' ? 'âœ… Deployed' : 'â­ï¸ Skipped'} |
            | **Dokploy Preview** | (LiveKit Voice Agent) | ${dokployStatusText} |

            ### Configuration
            All preview services are configured to use the same Convex preview backend:
            - **VITE_CONVEX_URL**: \`${convexUrl}\`
            - **CONVEX_URL (LiveKit)**: \`${convexSiteUrl}\`
            ${dokployNote}

            > Preview deployments are automatically coordinated via GitHub Actions.`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Preview Deployments')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

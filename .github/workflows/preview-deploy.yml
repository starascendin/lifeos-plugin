name: Preview Deployments

# Unified preview deployment workflow for PRs
# Handles: Convex Preview, Vercel Preview, Dokploy Preview
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "packages/holaaiconvex/**"
      - "packages/livekit-voice-agent/**"
      - "apps/lifeos/taurireact-macapp/**"
      - ".github/workflows/preview-deploy.yml"

env:
  DOKPLOY_APP_ID: r92eMjky2Tf04b37F1cLg
  DOKPLOY_BASE_URL: https://app.dokploy.com

permissions:
  contents: read
  pull-requests: write

jobs:
  # Step 0: Pre-set Dokploy previewEnv IMMEDIATELY (before Dokploy webhook fires)
  # This runs fast and sets previewEnv so Dokploy preview uses correct env
  dokploy-preset:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Pre-calculate Convex Preview URL
        id: calc
        run: |
          # Calculate expected preview name from branch (same logic as convex-preview job)
          BRANCH_NAME="${{ github.head_ref }}"
          PREVIEW_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          PREVIEW_NAME="${PREVIEW_NAME:0:32}"

          # Expected Convex site URL (may be overridden later if Convex generates different name)
          EXPECTED_URL="https://${PREVIEW_NAME}.convex.site"
          echo "Expected Convex URL: $EXPECTED_URL"
          echo "expected_url=$EXPECTED_URL" >> $GITHUB_OUTPUT

      - name: Pre-set Dokploy previewEnv (fast, before Dokploy webhook)
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          EXPECTED_CONVEX_URL: ${{ steps.calc.outputs.expected_url }}
        run: |
          echo "Pre-setting Dokploy previewEnv with expected CONVEX_URL: $EXPECTED_CONVEX_URL"

          PREVIEW_ENV="LIVEKIT_URL=wss://livekit-dev.rocketjump.tech
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CONVEX_URL=$EXPECTED_CONVEX_URL"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_BASE_URL/api/trpc/application.update" \
            -H "x-api-key: $DOKPLOY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"json\": {
                \"applicationId\": \"$DOKPLOY_APP_ID\",
                \"previewEnv\": \"$(echo "$PREVIEW_ENV" | sed ':a;N;$!ba;s/\n/\\n/g')\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully pre-set Dokploy previewEnv"
          else
            echo "Warning: Could not pre-set previewEnv (HTTP $HTTP_CODE)"
          fi

  # Step 1: Deploy Convex Preview (all other services depend on this)
  convex-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      convex_url: ${{ steps.deploy.outputs.convex_url }}
      convex_site_url: ${{ steps.deploy.outputs.convex_site_url }}
      preview_name: ${{ steps.deploy.outputs.preview_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Convex CLI
        run: npm install -g convex

      - name: Install dependencies
        working-directory: packages/holaaiconvex
        run: npm install

      - name: Deploy Convex Preview
        id: deploy
        working-directory: packages/holaaiconvex
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_PREVIEW_DEPLOY_KEY }}
        run: |
          # Create a preview name from the branch (sanitize for Convex)
          BRANCH_NAME="${{ github.head_ref }}"
          # Replace non-alphanumeric chars with dashes, lowercase
          PREVIEW_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          # Truncate to 32 chars max
          PREVIEW_NAME="${PREVIEW_NAME:0:32}"

          echo "Deploying Convex preview: $PREVIEW_NAME"

          # Deploy to preview and capture output
          DEPLOY_OUTPUT=$(npx convex deploy --preview-create "$PREVIEW_NAME" 2>&1) || {
            echo "Deploy output: $DEPLOY_OUTPUT"
            exit 1
          }

          echo "Deploy output:"
          echo "$DEPLOY_OUTPUT"

          # Extract the preview URL from the output
          CONVEX_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[a-zA-Z0-9-]+\.convex\.cloud' | head -1)

          if [ -z "$CONVEX_URL" ]; then
            echo "Could not extract Convex URL from deploy output, constructing it"
            CONVEX_URL="https://${PREVIEW_NAME}.convex.cloud"
          fi

          # Convert .convex.cloud to .convex.site for HTTP actions
          CONVEX_SITE_URL=$(echo "$CONVEX_URL" | sed 's/\.convex\.cloud/.convex.site/')

          echo "Convex Preview URL: $CONVEX_URL"
          echo "Convex Site URL: $CONVEX_SITE_URL"

          echo "convex_url=$CONVEX_URL" >> $GITHUB_OUTPUT
          echo "convex_site_url=$CONVEX_SITE_URL" >> $GITHUB_OUTPUT
          echo "preview_name=$PREVIEW_NAME" >> $GITHUB_OUTPUT

  # Step 2: Deploy Vercel Preview with correct Convex URL
  vercel-preview:
    runs-on: ubuntu-latest
    needs: convex-preview
    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_TAURI_LIFEOSAPP_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project with Preview Convex URL
        env:
          SKIP_CONVEX_DEPLOY: "1"
          VITE_CONVEX_URL: ${{ needs.convex-preview.outputs.convex_url }}
        run: |
          echo "Building with SKIP_CONVEX_DEPLOY=$SKIP_CONVEX_DEPLOY"
          echo "Building with VITE_CONVEX_URL=$VITE_CONVEX_URL"
          # Export vars for the vercel build subprocess
          export SKIP_CONVEX_DEPLOY
          export VITE_CONVEX_URL
          vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          # Deploy and capture the preview URL
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          echo "$DEPLOY_OUTPUT"

          # Extract the preview URL from output
          PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | grep -oE 'https://[a-zA-Z0-9-]+\.vercel\.app' | head -1)

          if [ -z "$PREVIEW_URL" ]; then
            # Try alternative pattern
            PREVIEW_URL=$(echo "$DEPLOY_OUTPUT" | tail -1 | tr -d '[:space:]')
          fi

          echo "Vercel Preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

  # Step 3: Update Dokploy Preview Environment (for LiveKit Voice Agent)
  dokploy-preview:
    runs-on: ubuntu-latest
    needs: convex-preview
    outputs:
      preview_triggered: ${{ steps.trigger_preview.outputs.preview_triggered }}

    steps:
      - name: Update Dokploy Preview Environment
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          CONVEX_URL: ${{ needs.convex-preview.outputs.convex_site_url }}
        run: |
          echo "Updating Dokploy previewEnv with CONVEX_URL: $CONVEX_URL"

          # Build the preview environment variables
          PREVIEW_ENV="LIVEKIT_URL=wss://livekit-dev.rocketjump.tech
          LIVEKIT_API_KEY=${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.LIVEKIT_API_SECRET }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          CONVEX_URL=$CONVEX_URL"

          # Update Dokploy application previewEnv via API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_BASE_URL/api/trpc/application.update" \
            -H "x-api-key: $DOKPLOY_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"json\": {
                \"applicationId\": \"$DOKPLOY_APP_ID\",
                \"previewEnv\": \"$(echo "$PREVIEW_ENV" | sed ':a;N;$!ba;s/\n/\\n/g')\"
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully updated Dokploy previewEnv"
          else
            echo "Failed to update Dokploy: HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: Trigger Preview Deploy via Webhook
        id: trigger_preview
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.head_ref }}
        run: |
          echo "Triggering Dokploy preview deployment..."
          echo "PR #$PR_NUMBER, Branch: $PR_BRANCH"

          # Get the application refresh token for webhook
          APP_RESPONSE=$(curl -s -X GET \
            "$DOKPLOY_BASE_URL/api/trpc/application.one?input=%7B%22json%22%3A%7B%22applicationId%22%3A%22$DOKPLOY_APP_ID%22%7D%7D" \
            -H "x-api-key: $DOKPLOY_API_TOKEN" \
            -H "Content-Type: application/json")

          REFRESH_TOKEN=$(echo "$APP_RESPONSE" | jq -r '.result.data.json.refreshToken')
          echo "Got refresh token: ${REFRESH_TOKEN:0:8}..."

          # Wait a moment to ensure previewEnv update is processed
          sleep 3

          # Trigger deploy via webhook endpoint
          # This simulates a GitHub push event to trigger preview creation/update
          echo "Calling webhook endpoint..."
          WEBHOOK_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DOKPLOY_BASE_URL/api/deploy/$REFRESH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"ref\": \"refs/heads/$PR_BRANCH\",
              \"repository\": {
                \"full_name\": \"${{ github.repository }}\"
              }
            }")

          HTTP_CODE=$(echo "$WEBHOOK_RESPONSE" | tail -1)
          BODY=$(echo "$WEBHOOK_RESPONSE" | head -n -1)

          echo "Webhook response: HTTP $HTTP_CODE"
          echo "$BODY"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Successfully triggered preview deployment"
            echo "preview_triggered=true" >> $GITHUB_OUTPUT
          else
            echo "Webhook didn't work, trying application.redeploy API..."

            # Alternative: try application.redeploy
            REDEPLOY_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "$DOKPLOY_BASE_URL/api/trpc/application.redeploy" \
              -H "x-api-key: $DOKPLOY_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"json\": {
                  \"applicationId\": \"$DOKPLOY_APP_ID\"
                }
              }")

            HTTP_CODE2=$(echo "$REDEPLOY_RESPONSE" | tail -1)
            echo "Redeploy response: HTTP $HTTP_CODE2"

            if [ "$HTTP_CODE2" -eq 200 ]; then
              echo "Triggered main app redeploy (may affect previews)"
              echo "preview_triggered=maybe" >> $GITHUB_OUTPUT
            else
              echo "Could not trigger deploy. Preview may need manual intervention."
              echo "preview_triggered=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Step 4: Comment on PR with all preview URLs
  comment:
    runs-on: ubuntu-latest
    needs: [convex-preview, vercel-preview, dokploy-preview]
    if: always() && needs.convex-preview.result == 'success'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const convexUrl = '${{ needs.convex-preview.outputs.convex_url }}';
            const convexSiteUrl = '${{ needs.convex-preview.outputs.convex_site_url }}';
            const previewName = '${{ needs.convex-preview.outputs.preview_name }}';
            const vercelUrl = '${{ needs.vercel-preview.outputs.preview_url }}' || 'N/A';
            const dokployStatus = '${{ needs.dokploy-preview.result }}';
            const previewTriggered = '${{ needs.dokploy-preview.outputs.preview_triggered }}';

            let dokployStatusText = 'â­ï¸ Skipped/Failed';
            let dokployNote = '';

            if (dokployStatus === 'success') {
              if (previewTriggered === 'true') {
                dokployStatusText = 'âœ… Deployed with correct env';
              } else if (previewTriggered === 'maybe') {
                dokployStatusText = 'ðŸ”„ Redeploying...';
              } else {
                dokployStatusText = 'âš ï¸ May need manual redeploy';
                dokployNote = `
            > âš ï¸ **Note**: Could not auto-trigger preview redeploy. If the voice agent has wrong CONVEX_URL, manually redeploy in Dokploy.`;
              }
            }

            const body = `## ðŸš€ Preview Deployments

            | Service | URL | Status |
            |---------|-----|--------|
            | **Convex Preview** | \`${previewName}\` | âœ… Deployed |
            | **Convex Cloud** | ${convexUrl} | âœ… Ready |
            | **Convex Site** | ${convexSiteUrl} | âœ… Ready |
            | **Vercel Preview** | ${vercelUrl} | ${vercelUrl !== 'N/A' ? 'âœ… Deployed' : 'â­ï¸ Skipped'} |
            | **Dokploy Preview** | (LiveKit Voice Agent) | ${dokployStatusText} |

            ### Configuration
            All preview services are configured to use the same Convex preview backend:
            - **VITE_CONVEX_URL**: \`${convexUrl}\`
            - **CONVEX_URL (LiveKit)**: \`${convexSiteUrl}\`
            ${dokployNote}

            > Preview deployments are automatically coordinated via GitHub Actions.`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Preview Deployments')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

name: Deploy Agent Farm - K8s Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infra/claude-agent-farm/k8s/base/**'
      - 'infra/claude-agent-farm/k8s/storage/**'
      - 'infra/claude-agent-farm/k8s/controlplane/**'
      - '.github/workflows/agent-farm-deploy-infra.yaml'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_BASE64" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: kubectl cluster-info

      - name: Deploy base resources
        working-directory: infra/claude-agent-farm
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          echo "### Base resources applied" >> $GITHUB_STEP_SUMMARY

      - name: Deploy storage (NFS)
        working-directory: infra/claude-agent-farm
        run: |
          kubectl apply -f k8s/storage/nfs-server.yaml
          kubectl wait --for=condition=ready pod -l app=nfs-server -n storage --timeout=120s || true
          kubectl apply -f k8s/storage/claude-credentials-pvc.yaml
          echo "### Storage deployed" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Kata runtime
        working-directory: infra/claude-agent-farm
        run: |
          kubectl apply -f k8s/base/kata-deploy.yaml
          echo "### Kata runtime deployed" >> $GITHUB_STEP_SUMMARY

      - name: Deploy control plane
        working-directory: infra/claude-agent-farm
        run: |
          kubectl apply -f k8s/controlplane/rbac.yaml
          kubectl apply -f k8s/controlplane/deployment.yaml
          kubectl rollout status deployment/controlplane -n controlplane --timeout=120s
          echo "### Control plane deployed" >> $GITHUB_STEP_SUMMARY

      - name: Show deployment status
        run: |
          echo "### Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -A >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup kubeconfig
        if: always()
        run: rm -f ~/.kube/config

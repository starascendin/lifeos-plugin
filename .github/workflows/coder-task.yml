name: Coder Task
on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  coder-task:
    runs-on: ubuntu-latest
    # Trigger on PR comments starting with /coder
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/coder')

    steps:
      - name: Extract prompt from comment
        id: extract
        run: |
          COMMENT='${{ github.event.comment.body }}'
          # Remove /coder prefix and trim
          PROMPT=$(echo "$COMMENT" | sed 's|^/coder[[:space:]]*||')
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Coder Task
        uses: coder/create-task-action@v0
        with:
          coder-url: ${{ secrets.CODER_URL }}
          coder-token: ${{ secrets.CODER_TOKEN }}
          coder-organization: "default"
          coder-template-name: "testtaskdocker"
          coder-template-preset: "hola-monorepo"
          coder-task-name-prefix: "gh-pr"
          coder-task-prompt: |
            GitHub PR: ${{ github.event.issue.pull_request.html_url }}

            ${{ steps.extract.outputs.prompt }}
          github-user-id: ${{ github.event.sender.id }}
          github-issue-url: ${{ github.event.issue.html_url }}
          github-token: ${{ github.token }}
          comment-on-issue: true

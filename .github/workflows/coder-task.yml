name: Coder Task
on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  coder-task:
    runs-on: ubuntu-latest
    # Trigger on PR comments containing /coder
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/coder')

    steps:
      - name: Extract prompt from comment
        id: extract
        run: |
          COMMENT='${{ github.event.comment.body }}'
          # Remove /coder and everything before it, then trim
          PROMPT=$(echo "$COMMENT" | sed 's|.*/coder[[:space:]]*||')
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Coder Task
        id: coder
        env:
          CODER_URL: ${{ secrets.CODER_URL }}
          CODER_TOKEN: ${{ secrets.CODER_TOKEN }}
          PROMPT: ${{ steps.extract.outputs.prompt }}
          PR_URL: ${{ github.event.issue.pull_request.html_url }}
        run: |
          # Get template version ID
          TEMPLATES=$(curl -s "$CODER_URL/api/v2/templates" \
            -H "Coder-Session-Token: $CODER_TOKEN")

          VERSION_ID=$(echo "$TEMPLATES" | jq -r '.[] | select(.name=="testtaskdocker") | .active_version_id')

          if [ -z "$VERSION_ID" ] || [ "$VERSION_ID" = "null" ]; then
            echo "Error: Could not find template 'testtaskdocker'"
            exit 1
          fi

          # Get preset ID
          PRESETS=$(curl -s "$CODER_URL/api/v2/templateversions/$VERSION_ID/presets" \
            -H "Coder-Session-Token: $CODER_TOKEN")

          PRESET_ID=$(echo "$PRESETS" | jq -r '.[] | select(.Name=="hola-monorepo") | .ID')

          # Build prompt
          FULL_PROMPT="GitHub PR: $PR_URL

          $PROMPT"

          ESCAPED_PROMPT=$(echo "$FULL_PROMPT" | jq -Rs '.')

          # Build request
          if [ -n "$PRESET_ID" ] && [ "$PRESET_ID" != "null" ]; then
            REQUEST_BODY="{\"template_version_id\": \"$VERSION_ID\", \"template_version_preset_id\": \"$PRESET_ID\", \"input\": $ESCAPED_PROMPT}"
          else
            REQUEST_BODY="{\"template_version_id\": \"$VERSION_ID\", \"input\": $ESCAPED_PROMPT}"
          fi

          # Create task
          RESPONSE=$(curl -s -X POST \
            "$CODER_URL/api/v2/tasks/me" \
            -H "Coder-Session-Token: $CODER_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_BODY")

          echo "Response: $RESPONSE"

          TASK_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ -z "$TASK_ID" ] || [ "$TASK_ID" = "null" ]; then
            echo "Error creating task"
            exit 1
          fi

          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const taskId = '${{ steps.coder.outputs.task_id }}';
            const coderUrl = '${{ secrets.CODER_URL }}';
            const taskUrl = `${coderUrl}/tasks`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `**Coder Task Created**\n\nI've started working on this. [View Task](${taskUrl})\n\n<!-- coder-task-id: ${taskId} -->`
            });

# Claude Code Docker - Web Deployment Strategy

## Goal

Deploy the same Claude Code Docker setup we have locally (Tauri) to a VPS via Dokploy, accessible from the LifeOS web app on Vercel.

## Architecture

```
┌──────────────────┐           ┌─────────────────────────────────────────────┐
│ Vercel           │           │ Dokploy (VPS)                               │
│ ┌──────────────┐ │   HTTPS   │ ┌─────────────────┐    ┌────────────────┐  │
│ │ LifeOS       │─┼──────────▶│ │ claudecode-api  │───▶│ claude-agent-* │  │
│ │ Web App      │ │           │ │ (Hono + Bun)    │    │ (Docker)       │  │
│ └──────────────┘ │           │ └─────────────────┘    └────────────────┘  │
│                  │           │        │                       │           │
│                  │           │   Bearer Token           Volume Mounts     │
│                  │           │   Authentication         - credentials     │
│                  │           │                          - sessions        │
└──────────────────┘           └─────────────────────────────────────────────┘
```

## Components

### 1. API Server Package

**Location:** `packages/claudecode-api/`

**Tech Stack:**
- Bun runtime
- Hono framework (lightweight, fast)
- Docker SDK or shell exec for container management

**Endpoints:**

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/health` | Health check |
| `GET` | `/api/containers/:env` | Get container status |
| `POST` | `/api/containers/:env/start` | Start container |
| `POST` | `/api/containers/:env/stop` | Stop container |
| `POST` | `/api/execute` | Execute Claude prompt |
| `POST` | `/api/sessions` | Create new session |
| `GET` | `/api/sessions/:env` | List sessions for env |
| `DELETE` | `/api/sessions/:env/:id` | Delete session |

**Request/Response Examples:**

```typescript
// POST /api/execute
Request: {
  env: "dev" | "staging" | "prod",
  prompt: string,
  jsonOutput?: boolean,
  sessionId?: string
}

Response: {
  success: boolean,
  output?: string,
  error?: string,
  json_output?: string
}
```

### 2. Docker Setup on Dokploy

**Containers needed:**
- `claude-agent-dev`
- `claude-agent-staging`
- `claude-agent-prod`

**Volumes:**
- `claude-credentials` - Shared Claude authentication
- `claude-config` - Shared Claude config
- `claude-sessions-dev` - Dev session persistence
- `claude-sessions-staging` - Staging session persistence
- `claude-sessions-prod` - Prod session persistence

**Network:**
- Internal Docker network for API server ↔ containers communication
- Only API server exposed externally

### 3. Frontend Integration

Update `claudecode.ts` service to support both Tauri and Web modes:

```typescript
const isTauri = typeof window !== "undefined" && "__TAURI__" in window;
const API_URL = import.meta.env.VITE_CLAUDECODE_API_URL;
const API_TOKEN = import.meta.env.VITE_CLAUDECODE_API_TOKEN;

async function apiRequest<T>(path: string, options?: RequestInit): Promise<T> {
  const res = await fetch(`${API_URL}${path}`, {
    ...options,
    headers: {
      "Authorization": `Bearer ${API_TOKEN}`,
      "Content-Type": "application/json",
      ...options?.headers,
    },
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

export async function executePrompt(
  env: Environment,
  prompt: string,
  jsonOutput = false,
  sessionId?: string
): Promise<ClaudeCodeResult> {
  if (isTauri) {
    return invoke("execute_claude_prompt", { env, prompt, jsonOutput, sessionId });
  }
  return apiRequest("/api/execute", {
    method: "POST",
    body: JSON.stringify({ env, prompt, jsonOutput, sessionId }),
  });
}
```

---

## Implementation Steps

### Phase 1: API Server

1. **Create package structure**
   ```
   packages/claudecode-api/
   ├── src/
   │   ├── index.ts          # Main entry, Hono app
   │   ├── routes/
   │   │   ├── containers.ts # Container management routes
   │   │   ├── execute.ts    # Prompt execution route
   │   │   └── sessions.ts   # Session management routes
   │   ├── services/
   │   │   └── docker.ts     # Docker exec wrapper
   │   └── middleware/
   │       └── auth.ts       # Bearer token auth
   ├── Dockerfile
   ├── package.json
   └── tsconfig.json
   ```

2. **Implement Hono server**
   ```typescript
   // src/index.ts
   import { Hono } from "hono";
   import { cors } from "hono/cors";
   import { bearerAuth } from "hono/bearer-auth";
   import containers from "./routes/containers";
   import execute from "./routes/execute";
   import sessions from "./routes/sessions";

   const app = new Hono();

   app.use("*", cors({ origin: process.env.ALLOWED_ORIGINS?.split(",") || "*" }));
   app.use("/api/*", bearerAuth({ token: process.env.API_TOKEN! }));

   app.get("/health", (c) => c.json({ status: "ok" }));
   app.route("/api/containers", containers);
   app.route("/api/execute", execute);
   app.route("/api/sessions", sessions);

   export default app;
   ```

3. **Docker execution service**
   ```typescript
   // src/services/docker.ts
   import { $ } from "bun";

   export async function execInContainer(
     containerName: string,
     command: string[]
   ): Promise<{ stdout: string; stderr: string; success: boolean }> {
     const result = await $`docker exec ${containerName} ${command}`.quiet().nothrow();
     return {
       stdout: result.stdout.toString(),
       stderr: result.stderr.toString(),
       success: result.exitCode === 0,
     };
   }

   export async function getContainerStatus(env: string) {
     const name = `claude-agent-${env}`;
     const result = await $`docker ps -a --filter name=${name} --format "{{.Status}}"`.quiet();
     const status = result.stdout.toString().trim();
     return {
       exists: status.length > 0,
       running: status.startsWith("Up"),
       name,
     };
   }
   ```

4. **Create Dockerfile**
   ```dockerfile
   FROM oven/bun:1-alpine

   # Install Docker CLI (to exec into sibling containers)
   RUN apk add --no-cache docker-cli

   WORKDIR /app
   COPY package.json bun.lockb ./
   RUN bun install --frozen-lockfile

   COPY . .

   ENV PORT=3000
   EXPOSE 3000

   CMD ["bun", "run", "src/index.ts"]
   ```

### Phase 2: Dokploy Deployment

1. **Create Docker Compose for Dokploy**
   ```yaml
   # docker-compose.yml
   version: "3.8"

   services:
     claudecode-api:
       build: .
       ports:
         - "3000:3000"
       environment:
         - API_TOKEN=${API_TOKEN}
         - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
       volumes:
         - /var/run/docker.sock:/var/run/docker.sock  # Access host Docker
       networks:
         - claude-network
       restart: unless-stopped

   networks:
     claude-network:
       external: true
   ```

2. **Pre-create Claude agent containers on VPS**
   ```bash
   # Create network
   docker network create claude-network

   # Create volumes
   docker volume create claude-credentials
   docker volume create claude-config
   docker volume create claude-sessions-dev
   docker volume create claude-sessions-staging
   docker volume create claude-sessions-prod

   # Create containers (adjust MCP paths as needed)
   docker run -d --name claude-agent-dev \
     --network claude-network \
     -v claude-credentials:/home/node/.claude \
     -v claude-config:/home/node/.config \
     -v claude-sessions-dev:/home/node/.claude/projects \
     -v /path/to/mcp-configs/dev.mcp.json:/home/node/.mcp.json:ro \
     claude-agent

   # Repeat for staging and prod...
   ```

3. **Login to Claude in containers (one-time)**
   ```bash
   docker exec -it claude-agent-dev claude login
   docker exec -it claude-agent-staging claude login
   docker exec -it claude-agent-prod claude login
   ```

4. **Deploy API server via Dokploy**
   - Push code to repo
   - Create new service in Dokploy pointing to `packages/claudecode-api`
   - Set environment variables:
     - `API_TOKEN`: Generate with `openssl rand -hex 32`
     - `ALLOWED_ORIGINS`: `https://lifeos.yourdomain.com`
   - Configure domain: `claudecode-api.yourdomain.com`
   - Enable HTTPS (Dokploy handles via Let's Encrypt)

### Phase 3: Frontend Integration

1. **Add environment variables to Vercel**
   ```
   VITE_CLAUDECODE_API_URL=https://claudecode-api.yourdomain.com
   VITE_CLAUDECODE_API_TOKEN=<your-generated-token>
   ```

2. **Update service layer** (as shown above in Frontend Integration section)

3. **Test both modes**
   - Tauri app should still work (uses invoke)
   - Web app should work via API

---

## Security Checklist

- [ ] Generate strong API token (`openssl rand -hex 32`)
- [ ] Store token in Dokploy env vars (not in code)
- [ ] Store token in Vercel env vars (not in code)
- [ ] Configure CORS to only allow your domains
- [ ] Enable HTTPS on Dokploy (automatic with domain)
- [ ] Docker socket access limited to API container only
- [ ] Consider rate limiting (Hono has middleware)

## Environment Variables Summary

**Dokploy (API Server):**
```
API_TOKEN=<random-32-byte-hex>
ALLOWED_ORIGINS=https://lifeos.yourdomain.com,http://localhost:5173
```

**Vercel (Web App):**
```
VITE_CLAUDECODE_API_URL=https://claudecode-api.yourdomain.com
VITE_CLAUDECODE_API_TOKEN=<same-token-as-above>
```

---

## File Changes Required

| File | Change |
|------|--------|
| `packages/claudecode-api/*` | NEW - API server package |
| `apps/lifeos/taurireact-macapp/src/lib/services/claudecode.ts` | Add web API support |
| `.env.example` | Add new env vars |
| Dokploy | Deploy API + containers |
| Vercel | Add env vars |

---

## Future Enhancements

1. **WebSocket for streaming** - Real-time output instead of waiting for completion
2. **Queue system** - Handle long-running prompts gracefully
3. **Execution history in DB** - Persist results to Convex instead of localStorage
4. **Container auto-scaling** - Spin up/down based on usage

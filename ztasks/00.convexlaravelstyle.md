# Convex Laravel-Style Organization Proposal

## Overview

This proposal outlines a Laravel-inspired code organization approach for our Convex backend to support multiple apps (holaai, lifeos, etc.) within one shared backend while maintaining clear separation and scalability.

## Goals

1. **Multi-app support**: Separate domains for holaai, lifeos, and future apps
2. **Clear ownership**: Each app's code and data clearly distinguished
3. **Shared utilities**: Common code (auth, algorithms) centralized
4. **Scalability**: Easy to add new apps/features
5. **Discoverability**: Developers can quickly find code by domain

---

## Current Structure (Flat)

```
packages/holaaiconvex/convex/
├── _generated/
├── schema.ts           # All 17 tables
├── auth.ts, auth.config.ts
├── content.ts          # 339 lines
├── exercises.ts        # 292 lines
├── progress.ts         # 395 lines
├── ai.ts               # 444 lines
├── voice.ts            # 308 lines
├── users.ts, messages.ts, tts.ts, dev.ts, seed.ts
```

**Problems:**
- All tables in one schema, no clear app boundaries
- No separation between HolaAI-specific and shared code
- Hard to add new apps without cluttering

---

## Proposed Structure (Domain-Driven)

```
packages/holaaiconvex/convex/
├── _generated/                 # Auto-generated (untouched)
├── _lib/                       # Shared utilities (underscore = not API)
│   ├── auth.ts                 # Auth helpers (requireAuth, getCurrentUser)
│   ├── algorithms/
│   │   └── sm2.ts              # Spaced repetition algorithm
│   └── validators.ts           # Common validators
│
├── schema.ts                   # Master schema (imports domains)
├── auth.config.ts              # Clerk config
│
├── holaai/                     # HolaAI Spanish learning app
│   ├── schema.ts               # hola_* tables
│   ├── content.ts              # Content queries/mutations
│   ├── exercises.ts            # Exercises
│   ├── progress.ts             # Progress tracking
│   ├── ai.ts                   # AI features
│   ├── voice.ts                # LiveKit/voice
│   └── seed.ts                 # Seeding
│
├── common/                     # Shared across all apps
│   ├── schema.ts               # users, messages tables
│   ├── users.ts
│   ├── messages.ts
│   ├── tts.ts
│   └── dev.ts
│
└── lifeos/                     # Future LifeOS app
    ├── schema.ts               # life_* tables
    ├── tasks.ts
    ├── habits.ts
    └── goals.ts
```

---

## Schema Organization

### Master Schema (`schema.ts`)

```typescript
import { defineSchema } from "convex/server";
import { commonTables } from "./common/schema";
import { holaaiTables } from "./holaai/schema";
// import { lifeosTables } from "./lifeos/schema"; // Future

export default defineSchema({
  ...commonTables,
  ...holaaiTables,
  // ...lifeosTables,
});
```

### HolaAI Schema (`holaai/schema.ts`)

Tables prefixed with `hola_` for clear ownership:

```typescript
import { defineTable } from "convex/server";
import { v } from "convex/values";

export const holaaiTables = {
  // Learning Content
  hola_contentLevels: defineTable({
    name: v.string(),
    displayName: v.string(),
    description: v.string(),
    order: v.number(),
  }).index("by_order", ["order"]),

  hola_contentCategories: defineTable({
    levelId: v.id("hola_contentLevels"),
    name: v.string(),
    description: v.string(),
    icon: v.optional(v.string()),
    order: v.number(),
  })
    .index("by_level", ["levelId"])
    .index("by_level_order", ["levelId", "order"]),

  hola_vocabularyItems: defineTable({
    categoryId: v.id("hola_contentCategories"),
    spanish: v.string(),
    english: v.string(),
    pronunciation: v.optional(v.string()),
    example: v.optional(v.string()),
    imageUrl: v.optional(v.string()),
    audioUrl: v.optional(v.string()),
    difficulty: v.number(),
  }).index("by_category", ["categoryId"]),

  hola_grammarRules: defineTable({
    categoryId: v.id("hola_contentCategories"),
    title: v.string(),
    explanation: v.string(),
    examples: v.array(v.string()),
    difficulty: v.number(),
  }).index("by_category", ["categoryId"]),

  hola_phrases: defineTable({
    categoryId: v.id("hola_contentCategories"),
    spanish: v.string(),
    english: v.string(),
    context: v.optional(v.string()),
    audioUrl: v.optional(v.string()),
    difficulty: v.number(),
  }).index("by_category", ["categoryId"]),

  hola_lessons: defineTable({
    categoryId: v.id("hola_contentCategories"),
    title: v.string(),
    description: v.string(),
    vocabularyIds: v.array(v.id("hola_vocabularyItems")),
    grammarIds: v.array(v.id("hola_grammarRules")),
    phraseIds: v.array(v.id("hola_phrases")),
    order: v.number(),
  })
    .index("by_category", ["categoryId"])
    .index("by_category_order", ["categoryId", "order"]),

  // User Progress
  hola_userProgress: defineTable({
    userId: v.id("users"),
    contentType: v.string(),
    contentId: v.string(),
    masteryPercentage: v.number(),
    lastPracticedAt: v.number(),
    nextReviewAt: v.number(),
    repetitions: v.number(),
    easeFactor: v.number(),
    interval: v.number(),
    isFavorite: v.optional(v.boolean()),
  })
    .index("by_user", ["userId"])
    .index("by_user_content", ["userId", "contentType", "contentId"])
    .index("by_user_favorite", ["userId", "isFavorite"]),

  hola_userLevelProgress: defineTable({
    userId: v.id("users"),
    levelId: v.id("hola_contentLevels"),
    totalItems: v.number(),
    masteredItems: v.number(),
    inProgressItems: v.number(),
    lastStudiedAt: v.number(),
  })
    .index("by_user", ["userId"])
    .index("by_user_level", ["userId", "levelId"]),

  // Exercises
  hola_exercises: defineTable({
    categoryId: v.id("hola_contentCategories"),
    type: v.string(),
    question: v.string(),
    correctAnswer: v.string(),
    options: v.optional(v.array(v.string())),
    explanation: v.optional(v.string()),
    difficulty: v.number(),
    relatedContentId: v.optional(v.string()),
    relatedContentType: v.optional(v.string()),
  })
    .index("by_category", ["categoryId"])
    .index("by_type", ["type"]),

  hola_matchingPairs: defineTable({
    exerciseId: v.id("hola_exercises"),
    leftItem: v.string(),
    rightItem: v.string(),
    order: v.number(),
  }).index("by_exercise", ["exerciseId"]),

  hola_userExerciseProgress: defineTable({
    userId: v.id("users"),
    exerciseId: v.id("hola_exercises"),
    attempts: v.number(),
    correctAttempts: v.number(),
    lastAttemptAt: v.number(),
    bestScore: v.number(),
  })
    .index("by_user", ["userId"])
    .index("by_user_exercise", ["userId", "exerciseId"]),

  // AI Features
  hola_aiLessons: defineTable({
    userId: v.id("users"),
    topic: v.string(),
    level: v.string(),
    generatedContent: v.string(),
    createdAt: v.number(),
    status: v.string(),
  })
    .index("by_user", ["userId"])
    .index("by_user_topic", ["userId", "topic"]),

  hola_bellaConversations: defineTable({
    userId: v.id("users"),
    scenario: v.string(),
    messages: v.array(v.object({
      role: v.string(),
      content: v.string(),
      timestamp: v.number(),
    })),
    createdAt: v.number(),
    status: v.string(),
  }).index("by_user", ["userId"]),

  hola_voiceConversations: defineTable({
    userId: v.id("users"),
    scenario: v.string(),
    livekitRoomName: v.optional(v.string()),
    livekitToken: v.optional(v.string()),
    createdAt: v.number(),
    endedAt: v.optional(v.number()),
    status: v.string(),
  }).index("by_user", ["userId"]),
};
```

### Common Schema (`common/schema.ts`)

Shared tables without prefix:

```typescript
import { defineTable } from "convex/server";
import { v } from "convex/values";

export const commonTables = {
  users: defineTable({
    tokenIdentifier: v.optional(v.string()),
    email: v.string(),
    name: v.optional(v.string()),
    pictureUrl: v.optional(v.string()),
    emailVerificationTime: v.optional(v.number()),
    createdAt: v.optional(v.number()),
    updatedAt: v.optional(v.number()),
  })
    .index("by_tokenIdentifier", ["tokenIdentifier"])
    .index("by_email", ["email"]),

  messages: defineTable({
    content: v.string(),
    userId: v.optional(v.string()),
    userName: v.optional(v.string()),
    createdAt: v.number(),
  }).index("by_createdAt", ["createdAt"]),
};
```

---

## API Path Mapping

| Current Path | New Path |
|--------------|----------|
| `api.content.listLevels` | `api.holaai.content.listLevels` |
| `api.content.createLevel` | `api.holaai.content.createLevel` |
| `api.exercises.listExercises` | `api.holaai.exercises.listExercises` |
| `api.exercises.generateQuiz` | `api.holaai.exercises.generateQuiz` |
| `api.progress.recordPractice` | `api.holaai.progress.recordPractice` |
| `api.progress.getUserStats` | `api.holaai.progress.getUserStats` |
| `api.ai.generateLesson` | `api.holaai.ai.generateLesson` |
| `api.ai.createBellaConversation` | `api.holaai.ai.createBellaConversation` |
| `api.voice.generateLiveKitToken` | `api.holaai.voice.generateLiveKitToken` |
| `api.users.currentUser` | `api.common.users.currentUser` |
| `api.users.ensureUser` | `api.common.users.ensureUser` |
| `api.messages.list` | `api.common.messages.list` |
| `api.messages.send` | `api.common.messages.send` |
| `api.tts.generateTTS` | `api.common.tts.generateTTS` |
| `api.dev.testGeminiConnection` | `api.common.dev.testGeminiConnection` |

---

## Shared Utilities (`_lib/`)

### Auth Helpers (`_lib/auth.ts`)

```typescript
// _lib/auth.ts
import { QueryCtx, MutationCtx } from "../_generated/server";
import { Id } from "../_generated/dataModel";

export async function getCurrentUser(ctx: QueryCtx | MutationCtx) {
  const identity = await ctx.auth.getUserIdentity();
  return identity || null;
}

export async function getAuthUserId(
  ctx: QueryCtx | MutationCtx
): Promise<Id<"users"> | null> {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) return null;

  const user = await ctx.db
    .query("users")
    .withIndex("by_tokenIdentifier", (q) =>
      q.eq("tokenIdentifier", identity.tokenIdentifier)
    )
    .unique();

  return user?._id ?? null;
}

export async function requireAuth(ctx: QueryCtx | MutationCtx) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) {
    throw new Error("Not authenticated");
  }
  return identity;
}

export async function requireUser(ctx: QueryCtx | MutationCtx) {
  const identity = await requireAuth(ctx);

  const user = await ctx.db
    .query("users")
    .withIndex("by_tokenIdentifier", (q) =>
      q.eq("tokenIdentifier", identity.tokenIdentifier)
    )
    .unique();

  if (!user) {
    throw new Error("User not found in database");
  }

  return user;
}

export async function getOrCreateUser(ctx: MutationCtx) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) return null;

  const existingUser = await ctx.db
    .query("users")
    .withIndex("by_tokenIdentifier", (q) =>
      q.eq("tokenIdentifier", identity.tokenIdentifier)
    )
    .unique();

  if (existingUser) return existingUser;

  const userId = await ctx.db.insert("users", {
    tokenIdentifier: identity.tokenIdentifier,
    email: identity.email ?? "",
    name: identity.name,
    pictureUrl: identity.pictureUrl,
    createdAt: Date.now(),
    updatedAt: Date.now(),
  });

  return await ctx.db.get(userId);
}
```

### SM-2 Algorithm (`_lib/algorithms/sm2.ts`)

```typescript
// _lib/algorithms/sm2.ts

export interface SM2Result {
  newInterval: number;
  newEaseFactor: number;
  nextReviewAt: number;
  newRepetitions: number;
}

/**
 * Calculate next review based on SM-2 spaced repetition algorithm
 * @param quality - Rating 0-5 (0-2 = fail, 3 = hard, 4 = good, 5 = easy)
 * @param easeFactor - Current ease factor (starts at 2.5)
 * @param interval - Current interval in days
 * @param repetitions - Number of successful repetitions
 */
export function calculateNextReview(
  quality: number,
  easeFactor: number,
  interval: number,
  repetitions: number
): SM2Result {
  let newEaseFactor = easeFactor;
  let newInterval = interval;
  let newRepetitions = repetitions;

  if (quality < 3) {
    // Failed - reset
    newInterval = 1;
    newRepetitions = 0;
  } else {
    // Passed
    newRepetitions = repetitions + 1;

    if (newRepetitions === 1) {
      newInterval = 1;
    } else if (newRepetitions === 2) {
      newInterval = 6;
    } else {
      newInterval = Math.round(interval * easeFactor);
    }

    // Update ease factor
    newEaseFactor = Math.max(
      1.3,
      easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
    );
  }

  const nextReviewAt = Date.now() + newInterval * 24 * 60 * 60 * 1000;

  return { newInterval, newEaseFactor, nextReviewAt, newRepetitions };
}

/**
 * Convert quality rating to mastery percentage change
 */
export function qualityToMastery(quality: number, currentMastery: number): number {
  if (quality >= 4) {
    return Math.min(100, currentMastery + 15);
  } else if (quality === 3) {
    return Math.min(100, currentMastery + 5);
  } else if (quality === 2) {
    return Math.max(0, currentMastery - 5);
  } else {
    return Math.max(0, currentMastery - 15);
  }
}
```

---

## Function Organization Pattern

Each domain file contains queries, mutations, and actions with clear section headers:

```typescript
// holaai/content.ts
import { query, mutation } from "../_generated/server";
import { v } from "convex/values";
import { requireAuth, requireUser } from "../_lib/auth";

// ==================== QUERIES ====================

export const listLevels = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db
      .query("hola_contentLevels")
      .withIndex("by_order")
      .order("asc")
      .collect();
  },
});

export const getLevel = query({
  args: { levelId: v.id("hola_contentLevels") },
  handler: async (ctx, args) => {
    return await ctx.db.get(args.levelId);
  },
});

export const listCategories = query({
  args: { levelId: v.id("hola_contentLevels") },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("hola_contentCategories")
      .withIndex("by_level_order", (q) => q.eq("levelId", args.levelId))
      .order("asc")
      .collect();
  },
});

// ==================== MUTATIONS ====================

export const createLevel = mutation({
  args: {
    name: v.string(),
    displayName: v.string(),
    description: v.string(),
    order: v.number(),
  },
  handler: async (ctx, args) => {
    await requireAuth(ctx);
    return await ctx.db.insert("hola_contentLevels", args);
  },
});
```

---

## Frontend Integration Changes

### Before

```typescript
import { api } from "@holaaiconvex/convex/_generated/api";

// In React Native / TanStack app
const levels = useQuery(api.content.listLevels);
const createLevel = useMutation(api.content.createLevel);
const progress = useQuery(api.progress.getUserStats);
```

### After

```typescript
import { api } from "@holaaiconvex/convex/_generated/api";

// Updated paths reflect domain structure
const levels = useQuery(api.holaai.content.listLevels);
const createLevel = useMutation(api.holaai.content.createLevel);
const progress = useQuery(api.holaai.progress.getUserStats);

// Common functions
const user = useQuery(api.common.users.currentUser);
const messages = useQuery(api.common.messages.list);
```

---

## Future LifeOS App Structure

```
lifeos/
├── schema.ts              # life_* tables
│   - life_tasks
│   - life_habits
│   - life_goals
│   - life_journal
│   - life_dailyReview
│
├── tasks.ts               # Task management
├── habits.ts              # Habit tracking
├── goals.ts               # Goal setting
├── journal.ts             # AI-powered journaling
└── reviews.ts             # Daily/weekly reviews
```

```typescript
// lifeos/schema.ts
export const lifeosTables = {
  life_tasks: defineTable({
    userId: v.id("users"),
    title: v.string(),
    description: v.optional(v.string()),
    status: v.string(),
    priority: v.number(),
    dueDate: v.optional(v.number()),
    // ...
  }).index("by_user", ["userId"]),

  life_habits: defineTable({
    userId: v.id("users"),
    name: v.string(),
    frequency: v.string(),
    streak: v.number(),
    // ...
  }).index("by_user", ["userId"]),

  // ... more tables
};
```

---

## Migration Checklist

### Phase 1: Create Structure
- [ ] Create `_lib/` directory with auth.ts and algorithms/sm2.ts
- [ ] Create `holaai/` directory
- [ ] Create `common/` directory
- [ ] Create `lifeos/` directory (empty placeholder)

### Phase 2: Schema Migration
- [ ] Create `holaai/schema.ts` with hola_* tables
- [ ] Create `common/schema.ts` with users, messages
- [ ] Update main `schema.ts` to compose from domains
- [ ] Rename all table references in code

### Phase 3: Function Migration
- [ ] Move content.ts to holaai/content.ts
- [ ] Move exercises.ts to holaai/exercises.ts
- [ ] Move progress.ts to holaai/progress.ts
- [ ] Move ai.ts to holaai/ai.ts
- [ ] Move voice.ts to holaai/voice.ts
- [ ] Move seed.ts to holaai/seed.ts
- [ ] Move users.ts to common/users.ts
- [ ] Move messages.ts to common/messages.ts
- [ ] Move tts.ts to common/tts.ts
- [ ] Move dev.ts to common/dev.ts

### Phase 4: Frontend Updates
- [ ] Update all API imports in apps/holaai-rnapp/
- [ ] Update all API imports in apps/holaai-tanstack-web/

### Phase 5: Cleanup
- [ ] Remove old flat files
- [ ] Run `npx convex dev` to verify
- [ ] Test all functionality end-to-end

---

## Benefits Summary

| Aspect | Before | After |
|--------|--------|-------|
| **Organization** | Flat, all in one folder | Domain-driven, clear hierarchy |
| **Multi-app** | Not supported | First-class support |
| **Table ownership** | Unclear | Prefixed (hola_, life_) |
| **Shared code** | Mixed with features | Centralized in _lib/ |
| **Discoverability** | Search required | Navigate by domain |
| **Scalability** | Gets messy | Clean separation |

---

## Sources

- [Laravel Domain-Driven Design](https://dev.to/arafatweb/a-simple-guide-to-domain-driven-design-ddd-in-laravel-15cp)
- [Beyond MVC in Laravel](https://vans.dev/blog/2025-08-04-beyond-mvc-laravel-applications-with-ddd-and-vsa/)
- [Convex Best Practices](https://docs.convex.dev/understanding/best-practices/)
- [Convex Functions in Subdirectories](https://docs.convex.dev/functions)
